name: π“¦ iOS λΉλ“ & π€ TestFlight λ°°ν¬

on:
  push:
    branches: [deploy]
  workflow_dispatch:

jobs:
  build_and_submit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write        # CHANGELOG μ½κΈ°
      id-token: write        # App Store μΈμ¦μ© OIDC

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_SECRET_ACCESS_TOKEN }}
      EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: π” version.ymlμ—μ„ μµμ‹  λ²„μ „ ν™•μΈ
        id: current_version
        run: |
          # version.ymlμ—μ„ λ²„μ „ μ¶”μ¶
          if [ -f "version.yml" ]; then
            CURRENT_VERSION=$(grep '^version:' version.yml | sed 's/version: *"\?\([^"]*\)"\?/\1/')
            echo "β… version.ymlμ—μ„ λ²„μ „ μ¶”μ¶: $CURRENT_VERSION"
          else
            # λ°±μ—…: app.jsonμ—μ„ λ²„μ „ μ¶”μ¶
            CURRENT_VERSION=$(grep '"version":' app.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
            echo "β οΈ version.ymlμ΄ μ—†μ–΄μ„ app.jsonμ—μ„ λ²„μ „ μ¶”μ¶: $CURRENT_VERSION"
          fi
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "π“‹ ν„μ¬ μ‚¬μ©ν•  λ²„μ „: $CURRENT_VERSION"

      # π†• changeLog.jsonμ—μ„ λ¦΄λ¦¬μ¦ λ…ΈνΈ μƒμ„±
      - name: π“ λ¦΄λ¦¬μ¦ λ…ΈνΈ μƒμ„± (changeLog.json κΈ°λ°)
        id: release_notes
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"

          # changeLog.json λλ” CHANGELOG.jsonμ—μ„ λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶
          CHANGELOG_FILE=""
          if [ -f "changeLog.json" ]; then
            CHANGELOG_FILE="changeLog.json"
            echo "π“„ changeLog.json νμΌ λ°κ²¬"
          elif [ -f "CHANGELOG.json" ]; then
            CHANGELOG_FILE="CHANGELOG.json"
            echo "π“„ CHANGELOG.json νμΌ λ°κ²¬"
          fi

          if [ -n "$CHANGELOG_FILE" ]; then
            echo "π“„ $CHANGELOG_FILEμ—μ„ v$CURRENT_VERSION λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶ μ¤‘..."

            python3 << PYTHON_SCRIPT > release_notes.txt
          import json
          import sys

          try:
              with open('$CHANGELOG_FILE', 'r', encoding='utf-8') as f:
                  data = json.load(f)

              version = "$CURRENT_VERSION"
              found = False

              # releases λ°°μ—΄μ—μ„ μµμ‹  λ²„μ „ μ°ΎκΈ°
              for release in data['releases']:
                  if release['version'] == version:
                      found = True
                      print(f"π“± λ²„μ „ {version} μ—…λ°μ΄νΈ")
                      print()

                      # AIκ°€ μƒμ„±ν• λ¨λ“  μΉ΄ν…κ³ λ¦¬λ¥Ό λ™μ μΌλ΅ μ²λ¦¬
                      for category_key, items in release['parsed_changes'].items():
                          if items:
                              # μƒ ν•μ‹μΈμ§€ κΈ°μ΅΄ ν•μ‹μΈμ§€ ν™•μΈ
                              if isinstance(items, dict) and 'title' in items and 'items' in items:
                                  title = items['title']
                                  actual_items = items['items']
                              else:
                                  # μΉ΄ν…κ³ λ¦¬λ… ν•κΈ€ν™”
                                  category_mapping = {
                                      'chores': 'π”§ κ°μ„ μ‚¬ν•­',
                                      'features': 'β¨ μƒλ΅μ΄ κΈ°λ¥', 
                                      'bugfixes': 'π› λ²„κ·Έ μμ •',
                                      'documentation': 'π“ λ¬Έμ„ μ—…λ°μ΄νΈ',
                                      'refactor': 'β™»οΈ λ¦¬ν©ν† λ§',
                                      'style': 'π¨ μ¤νƒ€μΌ λ³€κ²½',
                                      'test': 'π§ ν…μ¤νΈ',
                                      'performance': 'β΅ μ„±λ¥ κ°μ„ '
                                  }
                                  title = category_mapping.get(category_key, category_key.replace('_', ' ').title())
                                  actual_items = items

                              print(f"**{title}**")
                              for item in actual_items:
                                  if item.strip():
                                      print(f"β€Ά {item}")
                              print()

                      break

              if not found:
                  print(f"π“± λ²„μ „ {version} μ—…λ°μ΄νΈ")
                  print("β€Ά μ•± μ•μ •μ„± λ° μ‚¬μ©μ κ²½ν—μ΄ κ°μ„ λμ—μµλ‹λ‹¤.")

          except Exception as e:
              print(f"π“± λ²„μ „ {version} μ—…λ°μ΄νΈ")
              print("β€Ά μ•± μ•μ •μ„± λ° μ‚¬μ©μ κ²½ν—μ΄ κ°μ„ λμ—μµλ‹λ‹¤.")
              print(f"# μ¤λ¥: {str(e)}")
          PYTHON_SCRIPT

            if [ -s release_notes.txt ]; then
              echo "β… λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶ μ„±κ³µ!"
              echo "π“‹ μ¶”μ¶λ λ¦΄λ¦¬μ¦ λ…ΈνΈ:"
              echo "----------------------------------------"
              cat release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "β λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶ μ‹¤ν¨, κΈ°λ³Έ λ©”μ‹μ§€ μ‚¬μ©"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "π“± λ²„μ „ $CURRENT_VERSION μ—…λ°μ΄νΈ" > release_notes.txt
              echo "β€Ά μ•± μ•μ •μ„± λ° μ‚¬μ©μ κ²½ν—μ΄ κ°μ„ λμ—μµλ‹λ‹¤." >> release_notes.txt
            fi
          elif [ -f "CHANGELOG.md" ]; then
            echo "π“„ CHANGELOG.mdμ—μ„ v$CURRENT_VERSION λ³€κ²½μ‚¬ν•­ μ¶”μ¶ μ¤‘..."
            sed -n "/## \[$CURRENT_VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > current_release_notes.txt
            tail -n +2 current_release_notes.txt > release_notes_clean.txt
            sed '/^$/d; /^---$/d' release_notes_clean.txt > release_notes.txt
            if [ -s release_notes.txt ]; then
              echo "μ¶”μ¶λ λ³€κ²½μ‚¬ν•­:"
              cat release_notes.txt
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "ν„μ¬ λ²„μ „μ λ³€κ²½μ‚¬ν•­μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤."
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "π“± λ²„μ „ $CURRENT_VERSION μ—…λ°μ΄νΈ" > release_notes.txt
              echo "β€Ά μ•± μ•μ •μ„± λ° μ‚¬μ©μ κ²½ν—μ΄ κ°μ„ λμ—μµλ‹λ‹¤." >> release_notes.txt
            fi
          else
            echo "β οΈ changeLog.json, CHANGELOG.json, CHANGELOG.md νμΌμ΄ λ¨λ‘ μ—†μµλ‹λ‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "π“± λ²„μ „ $CURRENT_VERSION μ—…λ°μ΄νΈ" > release_notes.txt
            echo "β€Ά μ•± μ•μ •μ„± λ° μ‚¬μ©μ κ²½ν—μ΄ κ°μ„ λμ—μµλ‹λ‹¤." >> release_notes.txt
          fi

          # λ¦΄λ¦¬μ¦ λ…ΈνΈ νμΌ ν™•μΈ
          echo "π“‹ μµμΆ… λ¦΄λ¦¬μ¦ λ…ΈνΈ (release_notes.txt):"
          echo "========================================"
          cat release_notes.txt
          echo "========================================"

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: π“¦ Install dependencies
        run: npm install

      - uses: expo/expo-github-action@v8
        with:
          token: ${{ env.EXPO_TOKEN }}
          eas-version: latest

      # π”¨ λΉλ“λ§ μν–‰
      - name: π”¨ iOS μ•± λΉλ“
        run: |
          echo "π€ iOS λΉλ“ μ‹μ‘..."
          eas build \
            --platform ios \
            --profile production \
            --non-interactive

      # π€ TestFlightμ— μ μ¶ (λ¦΄λ¦¬μ¦ λ…ΈνΈ ν¬ν•¨)
      - name: π€ TestFlight μ μ¶
        run: |
          echo "π“‹ TestFlight μ μ¶μ© λ¦΄λ¦¬μ¦ λ…ΈνΈ:"
          echo "================================"
          cat release_notes.txt
          echo "================================"

          # TestFlightμ— μ μ¶ (λ¦΄λ¦¬μ¦ λ…ΈνΈ νμΌ ν¬ν•¨)
          eas submit \
            --platform ios \
            --profile production \
            --release-notes-file release_notes.txt \
            --non-interactive

          # μ„ νƒμ‚¬ν•­: OTA μ—…λ°μ΄νΈ λ©”μ‹μ§€λ„ κ°™μ΄ μ„¤μ •ν•λ ¤λ©΄ μ•„λ μ£Όμ„ ν•΄μ 
          # --message "$(cat release_notes.txt)"

    concurrency:
      group: ios-testflight
      cancel-in-progress: true