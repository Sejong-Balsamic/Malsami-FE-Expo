name: iOS 빌드 & TestFlight 배포

on:
  push:
    branches: [deploy]
  workflow_dispatch:

jobs:
  build_and_submit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write # CHANGELOG 읽기
      id-token: write # App Store 인증용 OIDC

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_SECRET_ACCESS_TOKEN }}
      EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 버전 확인
        id: current_version
        run: |
          chmod +x .github/scripts/version-manager.sh
          CURRENT_VERSION=$(./.github/scripts/version-manager.sh get | tail -n 1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "현재 사용할 버전: $CURRENT_VERSION"

      # 릴리즈 노트 생성
      - name: 릴리즈 노트 생성
        id: release_notes
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"

          # 기본 릴리즈 노트 생성
          echo "버전 $CURRENT_VERSION 업데이트" > release_notes.txt
          echo "앱 안정성 및 사용자 경험이 개선되었습니다." >> release_notes.txt
          echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV

          # 릴리즈 노트 파일 확인
          echo "최종 릴리즈 노트 (release_notes.txt):"
          echo "========================================"
          cat release_notes.txt
          echo "========================================"

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - uses: expo/expo-github-action@v8
        with:
          token: ${{ env.EXPO_TOKEN }}
          eas-version: latest

      # 빌드만 수행
      - name: iOS 앱 빌드
        run: |
          echo "iOS 빌드 시작..."
          eas build \
            --platform ios \
            --profile production \
            --non-interactive

      # TestFlight에 제출 (릴리즈 노트 포함)
      - name: TestFlight 제출
        run: |
          echo "TestFlight 제출용 릴리즈 노트:"
          echo "================================"
          cat release_notes.txt
          echo "================================"

          # TestFlight에 제출 (릴리즈 노트 파일 포함)
          eas submit \
            --platform ios \
            --profile production \
            --auto-submit \
            --non-interactive

          # 선택사항: OTA 업데이트 메시지도 같이 설정하려면 아래 주석 해제
          # --message "$(cat release_notes.txt)"

    concurrency:
      group: ios-testflight
      cancel-in-progress: true
