name: π“¦ iOS λΉλ“ & π€ TestFlight λ°°ν¬

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build_and_submit:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      id-token: write

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_SECRET_ACCESS_TOKEN }}
      EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ν„μ¬ λ²„μ „ ν™•μΈ
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '"version":' app.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ν„μ¬ λ²„μ „: $CURRENT_VERSION"

      # π†• λ¦΄λ¦¬μ¦ λ…ΈνΈ μƒμ„± (CHANGELOG.jsonμ—μ„ νμ‹±)
      - name: λ¦΄λ¦¬μ¦ λ…ΈνΈ μƒμ„±
        id: release_notes
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"

          # CHANGELOG.jsonμ—μ„ λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶
          if [ -f "CHANGELOG.json" ]; then
            echo "π“„ CHANGELOG.jsonμ—μ„ v$CURRENT_VERSION λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶ μ¤‘..."
            
            python3 << PYTHON_SCRIPT > release_notes.txt
          import json
          import sys

          try:
              with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              version = "$CURRENT_VERSION"
              found = False
              
              for release in data['releases']:
                  if release['version'] == version:
                      found = True
                      
                      # AIκ°€ μƒμ„±ν• λ¨λ“  μΉ΄ν…κ³ λ¦¬λ¥Ό λ™μ μΌλ΅ μ²λ¦¬
                      for category_key, items in release['parsed_changes'].items():
                          if items:
                              # μƒ ν•μ‹μΈμ§€ κΈ°μ΅΄ ν•μ‹μΈμ§€ ν™•μΈ
                              if isinstance(items, dict) and 'title' in items and 'items' in items:
                                  title = items['title']
                                  actual_items = items['items']
                              else:
                                  title = category_key.replace('_', ' ').title()
                                  actual_items = items
                              
                              print(f"**{title}**")
                              for item in actual_items:
                                  if item.strip():
                                      print(f"β€Ά {item}")
                              print()
                      
                      break
              
              if not found:
                  print(f"v{version} μ—…λ°μ΄νΈ")
                  
          except Exception as e:
              print(f"v{version} μ—…λ°μ΄νΈ")
          PYTHON_SCRIPT
            
            if [ -s release_notes.txt ]; then
              echo "β… λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶ μ„±κ³µ!"
              echo "π“‹ μ¶”μ¶λ λ¦΄λ¦¬μ¦ λ…ΈνΈ:"
              echo "----------------------------------------"
              cat release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "β λ¦΄λ¦¬μ¦ λ…ΈνΈ μ¶”μ¶ μ‹¤ν¨"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$CURRENT_VERSION μ—…λ°μ΄νΈ" > release_notes.txt
            fi
          elif [ -f "CHANGELOG.md" ]; then
            echo "π“„ CHANGELOG.mdμ—μ„ v$CURRENT_VERSION λ³€κ²½μ‚¬ν•­ μ¶”μ¶ μ¤‘..."
            sed -n "/## \[$CURRENT_VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > current_release_notes.txt
            tail -n +2 current_release_notes.txt > release_notes_clean.txt
            sed '/^$/d; /^---$/d' release_notes_clean.txt > release_notes.txt
            if [ -s release_notes.txt ]; then
              echo "μ¶”μ¶λ λ³€κ²½μ‚¬ν•­:"
              cat release_notes.txt
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "ν„μ¬ λ²„μ „μ λ³€κ²½μ‚¬ν•­μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤."
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$CURRENT_VERSION μ—…λ°μ΄νΈ" > release_notes.txt
            fi
          else
            echo "β οΈ CHANGELOG.jsonκ³Ό CHANGELOG.md νμΌμ΄ λ¨λ‘ μ—†μµλ‹λ‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$CURRENT_VERSION μ—…λ°μ΄νΈ" > release_notes.txt
          fi

          # λ¦΄λ¦¬μ¦ λ…ΈνΈλ¥Ό GitHub OutputμΌλ΅ μ„¤μ •
          RELEASE_NOTES=$(cat release_notes.txt | tr '\n' '\\n')
          echo "release_notes=$RELEASE_NOTES" >> $GITHUB_OUTPUT

          echo "π“‹ μµμΆ… λ¦΄λ¦¬μ¦ λ…ΈνΈ:"
          cat release_notes.txt

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: π“¦ Install dependencies
        run: npm install

      - uses: expo/expo-github-action@v8
        with:
          token: ${{ env.EXPO_TOKEN }}
          eas-version: latest

      - name: π”¨ Build & π€ Submit to TestFlight
        run: |
          echo "π“‹ μ‚¬μ©λ  ν•κµ­μ–΄ λ¦΄λ¦¬μ¦ λ…ΈνΈ:"
          echo "${{ steps.release_notes.outputs.release_notes }}"

          eas build \
            --platform ios \
            --profile production \
            --auto-submit \
            --non-interactive

    concurrency:
      group: ios-testflight
      cancel-in-progress: true
